env:
  global:
    - CUDA_VERSION: "8.0"
    - CUDA_SHORT_VERSION: "80"
    - UPLOAD_BUILD_ARTIFACTS: "true" # If "true", will upload build artifacts to S3 bucket at http://docs.openmm.org/build-artifacts/

osx_image: xcode6.4 # Supported versions: https://docs.travis-ci.com/user/languages/objective-c/#Supported-Xcode-versions

matrix:
  include:
    - sudo: required
      dist: trusty
      services:
        - docker
      env: BUILD="linux"
      addons: {apt: {packages: []}}

    - sudo: required
      dist: trusty
      services:
        - docker
      env: BUILD="source"
      addons: {apt: {packages: []}}

    - language: objective-c
      os: osx
      env: BUILD="osx"
      addons: {apt: {packages: []}}

script:
  - START_TIME=$(date +%s)
  - if [[ "$BUILD" == "linux" ]]; then

        docker run -e TRAVIS_PULL_REQUEST -e START_TIME
            -t -i --rm -v `pwd`:/io jchodera/omnia-build-box:cuda${CUDA_SHORT_VERSION}-amd30-clang38
            bash /io/devtools/travis/linux-build.sh;

    elif [[ "$BUILD" == "source" ]]; then

        docker run -e TRAVIS_PULL_REQUEST -e START_TIME
            -t -i --rm -v `pwd`:/io jchodera/omnia-build-box:cuda${CUDA_SHORT_VERSION}-amd30-clang38
            bash /io/devtools/travis/source-build.sh;

    elif [[ "$BUILD" == "osx" ]]; then

        echo "Building osx...";
        source devtools/travis/osx-build.sh;

    fi

# S3 deployment doesn't do anything right now. Will revive it later.
deploy:
  - provider: s3
    access_key_id:
      secure: "AjE3nuj6kVuf21mOf0aZydW/3S/uCWsaoXC/huRxkxrmsNlnHBNGHZ9N48san1IxZAQM5pyaf7Yo9gkHur9obgq+e3lNgGvPp2mfkNXtLYcLJ46JF4kYliAtutjLWskrLg25Gu3xzF4EQkqSe0Le/oWldWWbTgvvH+KRq/vTHzI="
    secret_access_key:
      secure: "ISDQNSG2t0666PULtffo4wsKLFdu622EzuZxmiTxvLkjQGQlqm5+qn1Gd5UMLk7Ts2E0psdnmSrf6LVVCfrrQO/hcZHiJw3ZslMPDBBlRr8Epwdldn98ULhVoyQKtjXjCPzroa2UZCl1RFs4Nwb/VdDlI490XV0Lp4Woj1AT8tY="
    bucket: "docs.openmm.org"
    skip_cleanup: true
    region: us-west-1
    local_dir: packaging/
    upload_dir: build-artifacts
    on:
      branch: master
      condition: '! -z "${UPLOAD_BUILD_ARTIFACTS}" && "${UPLOAD_BUILD_ARTIFACTS}" = "true"'
